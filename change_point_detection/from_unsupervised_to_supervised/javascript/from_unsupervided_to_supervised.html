<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.tick line{
	opacity: 0.1;
}

.dot {
  stroke: #000;
}

.overlay {
  fill: none;
  pointer-events: all;
}

</style>
</head>
<body>

<!--
<link href="./bootstrap/css/bootstrap.min.css" rel="stylesheet">
-->

<script src="./d3/d3.min.js"></script>
<script>

//january == 0
var date_begin = new Date(2015, 11, 1, 0, 0, 0, 0);
var num_days = 31;

console.log("date_begin=" + date_begin);

Date.prototype.addDays = function(days) {
    var dat = new Date(this.valueOf())
    dat.setDate(dat.getDate() + days);
    return dat;
}
function getDates(startDate, stopDate) {
    var dateArray = new Array();
    var currentDate = startDate;
    while (currentDate <= stopDate) {
        dateArray.push( new Date (currentDate) )
        currentDate = currentDate.addDays(1);
    }
    return dateArray;
}

var date_array = getDates(date_begin, date_begin.addDays(num_days));
console.log(date_array);

var margin = {top: 20, right: 20, bottom: 60, left: 40},
	width = 960 - margin.left - margin.right,
	height = 600 - margin.top - margin.bottom;

//var x = d3.scale.linear()
//	.range([0, width]);
var x = d3.time.scale()
	.range([0, width]);
var y = d3.scale.linear()
	.range([height, 0]);

var xAxis = d3.svg.axis()
	.scale(x)
	.orient("bottom")
	.tickSize(-height, 0, 0)
	.tickFormat(d3.time.format("%d/%m"))
	.tickValues(date_array);
var yAxis = d3.svg.axis()
	.scale(y)
	.orient("left")
	.tickSize(-width, 0, 0)
	.tickFormat(d3.format(",.2f"))
	.tickValues([0.0, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1.0]);	

var svg = d3.select("body").append("svg")
	.attr("width", width + margin.left + margin.right)
	.attr("height", height + margin.top + margin.bottom)
	.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

d3.csv("64:66:B3:50:03:A2.csv", function(data)
{
	var format = d3.time.format("%Y-%m-%d %H:%M:%S");
	
	data.forEach(function(d) 
	{
		strdt = d.dt.slice(0,19);
		d.dt = format.parse(strdt);

		//console.log("strdt=" + strdt);
		//console.log("d.dt=" + d.dt);
	});

	data.sort(function(a, b) { return a.dt - b.dt; });
	
	x.domain([date_array[0], date_array[date_array.length - 1]]);
	y.domain([-0.02, 1.02]);
	
	svg.append("g")
		.attr("class", "x axis")	
		.attr("transform", "translate(0," + height + ")")
		.call(xAxis)
		.selectAll("text")
			.attr("dx", "-2.5em")
			.attr("dy", "-0.1em")
			.attr("transform", "rotate(-65)");
	svg.append("g")
		.attr("class", "y axis")
		.call(yAxis)

	svg.selectAll(".dot")
	.data(data)
	.enter().append("circle")
		.attr("class", "dot")
		.attr("r", 1.0)
		.attr("cx", function(d) { return x(d.dt); })
		.attr("cy", function(d) { return y(d.loss); })

	svg.append("rect")
		.attr("class", "overlay")
		.attr("width", width)
		.attr("height", height)
		.on("click", add_change_point);
});

var change_points_array = []
function add_change_point()
{
	var px = x.invert(d3.mouse(this)[0]);
	var py = y.invert(d3.mouse(this)[1]);
	
	change_points_array.push(px)
		
	svg.append("line")
		.attr("id", "change_point_" + change_points_array.length)
		.attr("x1", x(px))		
		.attr("y1", y(y.domain()[0]))
		.attr("x2", x(px))
		.attr("y2", y(y.domain()[1]))
		.style("stroke-width", 2)
		.style("stroke", "red")
		.style("fill", "none")

	//window.alert("x=" + px + ", y=" + py);
}

function remove_change_point()
{
	if(change_points_array.length > 0)
	{
		//#select by id
		svg.selectAll("#change_point_" + change_points_array.length).remove();
		change_points_array.pop()	
	}
}

function save_change_points()
{

}

</script>
<div>
<button type="button" class="btn btn-primary" onclick="remove_change_point()">Remove last change point</button>
<button type="button" class="btn btn-primary" onclick="save_change_points()">Save and next</button>
</div>
<body>
</html>
